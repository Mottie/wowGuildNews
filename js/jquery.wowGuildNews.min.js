/* wowGuildNews minified v1.0 beta
 https://github.com/Mottie/wowGuildNews
 by Rob Garrison (Mottie) MIT licensed.
*/
;(function(g){g.fn.wowGuildNews=function(l){return this.each(function(){if(!this.initialized){var m=this,a=g.extend(!0,{show:25,small:!0,region:"us",locale:"en",server:"Lightning's Blade",guild:"Our Guild's Name",text:{guildinfo:"(Level {level} {faction} Guild, {server})",faction:["Alliance","Horde"],item:"{icon} {player} {action} {item}. {time}",achv:"{icon} {player} earned the achievement {ach} for {points} points. {time}",obtained:"obtained",crafted:"crafted",purchased:"purchased",guild:"The guild", recent:"Recently",now:"Just now",min:"1 minute ago",mins:"minutes ago",hour:"1 hour ago",hours:"hours ago",yday:"Yesterday",days:"days ago",weeks:"weeks ago"},itemTooltip:"http://{locale}.wowhead.com/item={id}",achTooltip:"http://{locale}.wowhead.com/achievement={id}"},l),i="http://"+("cn"===a.region?"www.battlenet.com.cn":a.region+".battle.net"),j=i+"/api/wow/",n=i+"/wow/"+a.locale+"/character/"+escape(a.server.toLowerCase())+"/",k="http://media.blizzard.com/wow/icons/"+(a.small?"18":"56")+"/",h= "wow-icon-"+(a.small?"small":"large"),p=a.itemTooltip.replace(/\{locale\}/g,"en"===a.locale?"www":a.locale),q=a.achTooltip.replace(/\{locale\}/g,"en"===a.locale?"www":a.locale),r=function(c){var e;e='<a class="wow-character-name" href="'+n+escape(c.character)+'/">'+c.character+"</a>";var b;b=new Date(c.timestamp||"");var d=parseInt(b.toLocaleTimeString().split(":"),10);b=0!==b.getHours()-d?b.getTime(b.setHours(d)):b.getTime();b=((new Date).getTime()-b)/1E3;d=Math.floor(b/86400);b=-1===d?a.text.recent: isNaN(d)||0>d||31<=d?"":0===d&&(60>b&&a.text.now||120>b&&" "+a.text.min||3600>b&&Math.floor(b/60)+" "+a.text.mins||7200>b&&a.text.hour||86400>b&&Math.floor(b/3600)+" "+a.text.hours)||1===d&&" "+a.text.yday||7>d&&d+" "+a.text.days||31>d&&Math.ceil(d/7)+" "+a.text.weeks;var f={"{player}":e,"{time}":'<span class="wow-action-time">'+b+"</span>."};b=/\{a\}/g;d=/\{player\}/gi;if(/item/.test(c.type))switch(f["{icon}"]='<span class="wow-icon '+h+" wow-icon-"+c.itemId+'"></span>',f["{item}"]=('<a class="wow-item wow-item-{id}" href="'+ p+'">item {id}</a>').replace(/\{id\}/g,c.itemId),f["{action}"]='<span class="wow-action-type wow-action-{a}">{a}</span>',e=a.text.item.replace(/(\{(icon|player|action|item|time)\})/g,function(a){return f[a]}),c.type){case "itemLoot":return e.replace(b,a.text.obtained);case "itemCraft":return e.replace(b,a.text.crafted);case "itemPurchase":return e.replace(b,a.text.purchased)}else if(c.achievement)switch(f["{icon}"]='<span class="wow-icon '+h+'"><img class="'+h+'" src="'+k+c.achievement.icon+'.jpg"></span>', f["{ach}"]=('<a class="wow-{a}-achievement" href="'+q+'">'+c.achievement.title+"</a>").replace(/\{id\}/g,c.achievement.id),f["{points}"]='<span class="wow-points">'+c.achievement.points+"</span>",e=a.text.achv.replace(/(\{(icon|ach|points|time)\})/g,function(a){return f[a]}),c.type){case "playerAchievement":return e.replace(d,f["{player}"]).replace(b,"character");case "guildAchievement":return e.replace(d,a.text.guild).replace(b,"guild")}return'<span class="unknown">Unknown news item</span>'},s=j+ "guild/"+escape(a.server)+"/"+escape(a.guild)+"?fields=news&jsonp=?",t=function(a){a.itemId&&g.ajax({url:j+"item/"+a.itemId+"?jsonp=?",dataType:"jsonp",async:!0,success:function(a){g(".wow-icon-"+a.id).html('<img class="'+h+'" src="'+k+a.icon+'.jpg" alt="'+a.name+'">');g(".wow-item-"+a.id).addClass("q"+a.quality).html(a.name)}})};g.getJSON(s,function(c){var e,b=c.news,d=Math.min(b.length,a.show),f='<h3 class="wow-guild-name"><a href="'+i+"/wow/"+a.locale+"/guild/"+a.server.toLowerCase().replace(/\s/g, "-").replace(/\'/g,"")+"/"+a.guild.replace(/\s/g,"_").replace(/\'/g,"")+'/">'+c.name+'</a></h3><h4 class="wow-guild-info">',f=f+(a.text.guildinfo.replace(/(\{(level|faction|server)\})/gi,function(b){return{"{level}":'<span class="wow-guild-level">'+c.level+"</span>","{faction}":'<span class="wow-guild-faction">'+a.text.faction[c.side]+"</span>","{server}":'<span class="wow-guild-realm">'+c.realm+"</span>"}[b]})+"</h4>");for(e=0;e<d;e++)f+='<div class="wow-news-item">'+r(b[e])+"</div>";g(m).addClass("wow-guild-news").html(f); for(e=0;e<d;e++)t(b[e])})}})}})(jQuery);
